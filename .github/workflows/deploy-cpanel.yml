name: Deploy to cPanel (UAPI)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    - name: Build Application
      run: npm run build
      env:
        DATABASE_HOST: localhost
        DATABASE_USER: text
        DATABASE_PASSWORD: test
        SESSION_SECRET: build-time-secret

    - name: Prepare Deployment Artifact (ZIP)
      run: |
        mkdir -p deploy_package
        
        # Copy standalone build
        cp -r .next/standalone/* deploy_package/
        
        # Copy static files (Next.js requirement)
        mkdir -p deploy_package/.next/static
        cp -r .next/static/* deploy_package/.next/static/
        
        # Copy public assets
        cp -r public deploy_package/public
        
        # Copy server.js
        cp .next/standalone/server.js deploy_package/server.js
        
        # Zip content
        cd deploy_package
        zip -r ../deployment.zip .
        cd ..
        
    - name: Upload Application (ZIP) via cPanel API
      run: |
        curl -X POST \
             -u "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" \
             -F "file-1=@deployment.zip" \
             -F "dir=/home/hafizjat/huffadz-jatim" \
             "http://${{ secrets.FTP_SERVER }}:2082/execute/Fileman/upload_files"

    - name: Upload Helper Script via cPanel API
      run: |
        curl -X POST \
             -u "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" \
             -F "file-1=@public/deploy_helper.php" \
             -F "dir=/home/hafizjat/public_html" \
             "http://${{ secrets.FTP_SERVER }}:2082/execute/Fileman/upload_files"

    - name: Trigger Extraction & Restart
      run: |
        curl -L "https://hafizjatim.my.id/deploy_helper.php?key=${{ secrets.DEPLOY_KEY }}"
